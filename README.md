# DBAData
DDL trigger

Логирование изменений в структуре таблиц/представлений БД

Версия 1.5
Автор: Попов Андрей 

ИСПОЛЬЗОВАНИЕ
-------------
Запустить ХП [adm].[spReportLog] для получения данных по изменениям таблиц/представлений.
Прототип ХП: [adm].[spReportLog] (@StartDate DATETIME, @EndDate DATETIME, @LoginName NVARCHAR(128) = NULL)
Параметр @LoginName - фильтр по пользователю, который вносил изменения является необязательным.  

Запустить ХП [adm].[spReportLogFP] для получения данных по изменениям процедур/функций. 
Прототип ХП: [adm].[spReportLogFP] (@StartDate DATETIME, @EndDate DATETIME, @FPName NVARCHAR(128) = NULL)
Параметр @FPName - фильтр по названию процедуры/функции является необязательным. 

РАЗВЕРТЫВАНИЕ
-------------
Для развертывания выполнить скрипты по порядку для выбранной БД, кроме скрипта "99 удалить все.sql".
Этот скрипт служит для удаления всех внесенных изменений. 

ОПИСАНИЕ
--------
Предполагается использование новой схемы adm для таблиц и ХП.
Предполагается использование той же БД, где и происходят изменения. 

Суть в создании триггера DDL уровня БД.
Основной источник информации: https://blog.sqlterritory.com/2018/12/11/5-ways-to-track-database-schema-changes-part-4-ddl-trigger/
Триггер срабатывает, когда происходят следующие события: DDL_TABLE_EVENTS (CREATE_TABLE, ALTER_TABLE, DROP_TABLE), 
DDL_VIEW_EVENTS (CREATE_VIEW, ALTER_VIEW, DROP_VIEW), RENAME.
При этом в триггере доступны xml-данные, получаемые функцией EVENTDATA().
Задача разобрать эти данные и сохранить их в таблицу(ы).

Код триггера минимален и заключается в вызове ХП с передачей в нее данных adm.spProcessEvent EVENTDATA().
Так как триггер вызывается в момент изменений структуры таблиц/представлений, то он влияет на скорость выполняемой операции. 
Также, в случае ошибки в триггере, операция изменения структуры заканчивается ошибкой и откатывается!

Чтобы выключить триггер: 
    DISABLE TRIGGER [trEventsLog] ON DATABASE

Чтобы включить: 
    ENABLE TRIGGER [trEventsLog] ON DATABASE

Созданы таблицы:
adm.EventsLog - содержит информацию о событии DDL, содержит EventUID - идентификатор события
adm.TablesLog - содержит информацию об изменении таблиц/представлений, изначально содержит список всех таблиц и представлений БД, 
                по EventUID таблица связана с adm.EventsLog
adm.ColumnsLog - содержит информацию об изменении столбцов таблиц/предствлений, изначально содержит список всех столбцов БД,
                по EventUID таблица связана с adm.EventsLog, поле ObjectID - это ID таблицы/представления

Созданы ХП:
adm.spInsertTablesLog - добавление в таблицу adm.TablesLog
adm.spInsertColumnsLog - добавление в таблицу adm.ColumnsLog
adm.spProcessEvent - обработка событий
adm.spClearLogs - очистка таблиц adm.EventsLog, adm.TablesLog, adm.ColumnsLog на указанную границу времени. 
		Из-за связей между записями фактически не будут удаляться все записи ранее указанной границы. 

adm.spFillBranchID_CL - этот набор ХП служит для заполнения поля BranchID - этот ID одинаков для всех действий 
adm.spFillBranchID_TL - с конкретной таблицей или конкретным полем
adm.spFindBranchID_CL - поле появилось в процессе разработки и необходимо было заполнить его значениями для уже
adm.spFindBranchID_TL - существовавших данных. В рабочем процессе эти ХП не используются.

В любом случае записывается событие в таблицу adm.EventsLog. При этом событию присваивается идентификатор EventUID.

При создании таблицы/представления ('CREATE_VIEW' или 'CREATE_TABLE') в таблицу adm.TablesLog записывается информация о создании объекта. 
А в таблицу adm.spInsertColumnsLog все созданные поля таблицы. 

При изменении таблицы/представления ('ALTER_TABLE' или 'ALTER_VIEW') добавляется запись в adm.TablesLog. Информацию о предыдущем изменении можно получить по полю PrevRecUID.
Также информация об изменяемых колонках (CREATE/ALTER/DROP) добавляется в таблицу. Информацию о предыдущем состоянии колонки можно получить по PrevRecUID. 

При удалении таблицы/представления ('DROP_VIEW', 'DROP_TABLE') добавляется запись только в adm.TablesLog. При этом информацию о предыдущем изменении можно получить по полю PrevRecUID.

При переименовании таблицы/представления (RENAME) добавляется запись только в adm.TablesLog. 
При этом информацию о предыдущем изменении можно получить по полю PrevRecUID.

При переименовании поля (RENAME) добавляется информация только в таблицу adm.ColumnsLog. Информацию о предыдущем состоянии колонки можно получить по PrevRecUID. 



